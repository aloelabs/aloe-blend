const chai = require("chai");
const chaiAsPromised = require("chai-as-promised");
const { artifacts } = require("hardhat");

const ERC20 = artifacts.require("@openzeppelin/contracts/token/ERC20/IERC20.sol:IERC20");

const AloeBlend = artifacts.require("AloeBlend");
const Factory = artifacts.require("Factory");
const VolatilityOracle = artifacts.require("VolatilityOracle");

const CompoundCEtherSilo = artifacts.require("CompoundCEtherSilo");
const CompoundCTokenSilo = artifacts.require("CompoundCTokenSilo");

chai.use(chaiAsPromised);
const expect = chai.expect;

web3.eth.extend({
  property: "hardhat",
  methods: [
    {
      name: "increaseTime",
      call: "evm_increaseTime",
      params: 1,
    },
    {
      name: "mine",
      call: "evm_mine",
      params: 0,
    },
    {
      name: "impersonate",
      call: "hardhat_impersonateAccount",
      params: 1,
    },
    {
      name: "stopImpersonating",
      call: "hardhat_stopImpersonatingAccount",
      params: 1,
    },
    {
      name: "reset",
      call: "hardhat_reset",
      params: 1,
      /*
      {
        forking: {
          jsonRpcUrl: "https://eth-mainnet.alchemyapi.io/v2/<key>",
          blockNumber: 11095000,
        },
      }
      */
    },
  ],
});

const BYTECODE =
  "0x6102006040523480156200001257600080fd5b5060405162005f5238038062005f5283398101604081905262000035916200067a565b82836001600160a01b0316630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000075573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200009b9190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620000d9573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526200010391908101906200073e565b846001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa15801562000142573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620001689190620006ce565b6001600160a01b03166395d89b416040518163ffffffff1660e01b8152600401600060405180830381865afa158015620001a6573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052620001d091908101906200073e565b604051602001620001e3929190620007f6565b604051602081830303815290604052806040518060400160405280600a815260200169105313d14b509311539160b21b8152506012826000908051906020019062000230929190620005bb565b50815162000246906001906020850190620005bb565b5060ff81166080524660a0526200025c620004ba565b60c052505050506001600160a01b03811660e081905260408051630dfe168160e01b81529051630dfe1681916004808201926020929091908290030181865afa158015620002ae573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620002d49190620006ce565b6001600160a01b0316610100816001600160a01b031681525050806001600160a01b031663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156200032d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003539190620006ce565b6001600160a01b0316610120816001600160a01b031681525050806001600160a01b031663d0c93a7c6040518163ffffffff1660e01b8152600401602060405180830381865afa158015620003ac573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003d291906200084d565b60020b6101408160020b8152505050620003ff620d89e719610140516200055660201b620021c11760201c565b60020b610160526200042e62000419620d89e71962000872565b610140516200058b60201b620021f01760201c565b60020b61018052604080516355b13a4f60e01b8152905133916355b13a4f9160048083019260209291908290030181865afa15801562000472573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620004989190620006ce565b6001600160a01b039081166101a0529182166101c052166101e05250620009b6565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6000604051620004ee9190620008e1565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b60008062000565838562000985565b905060008160020b1315620005805783038201905062000585565b830390505b92915050565b6000806200059a838562000985565b905060008160020b12620005b2578303905062000585565b90920303919050565b828054620005c990620008a4565b90600052602060002090601f016020900481019282620005ed576000855562000638565b82601f106200060857805160ff191683800117855562000638565b8280016001018555821562000638579182015b82811115620006385782518255916020019190600101906200061b565b50620006469291506200064a565b5090565b5b808211156200064657600081556001016200064b565b6001600160a01b03811681146200067757600080fd5b50565b6000806000606084860312156200069057600080fd5b83516200069d8162000661565b6020850151909350620006b08162000661565b6040850151909250620006c38162000661565b809150509250925092565b600060208284031215620006e157600080fd5b8151620006ee8162000661565b9392505050565b634e487b7160e01b600052604160045260246000fd5b60005b83811015620007285781810151838201526020016200070e565b8381111562000738576000848401525b50505050565b6000602082840312156200075157600080fd5b81516001600160401b03808211156200076957600080fd5b818401915084601f8301126200077e57600080fd5b815181811115620007935762000793620006f5565b604051601f8201601f19908116603f01168101908382118183101715620007be57620007be620006f5565b81604052828152876020848701011115620007d857600080fd5b620007eb8360208301602088016200070b565b979650505050505050565b6a020b637b290213632b732160ad1b8152600083516200081e81600b8501602088016200070b565b602f60f81b600b9184019182015283516200084181600c8401602088016200070b565b01600c01949350505050565b6000602082840312156200086057600080fd5b81518060020b8114620006ee57600080fd5b60008160020b627fffff198114156200089b57634e487b7160e01b600052601160045260246000fd5b60000392915050565b600181811c90821680620008b957607f821691505b60208210811415620008db57634e487b7160e01b600052602260045260246000fd5b50919050565b600080835481600182811c915080831680620008fe57607f831692505b60208084108214156200091f57634e487b7160e01b86526022600452602486fd5b818015620009365760018114620009485762000977565b60ff1986168952848901965062000977565b60008a81526020902060005b868110156200096f5781548b82015290850190830162000954565b505084890196505b509498975050505050505050565b60008260020b80620009a757634e487b7160e01b600052601260045260246000fd5b808360020b0791505092915050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e0516153c162000b916000396000818161094801528181610bb6015281816113420152818161179d0152818161195a01528181611a290152818161268501528181612a6901528181612b120152818161313401526134fc01526000818161057101528181610b84015281816113100152818161177301528181611800015281816118e00152818161259201528181612ca601528181612d4f015281816130d0015261346b0152600081816104df0152612e770152600081816130410152613073015260008181612fec0152613017015260008181610c7301528181610cb801528181610cff01528181610dd101528181610e1601528181610e5d01528181612f7e0152612fb701526000818161053d0152818161154701528181611cbf01528181611e6a015281816129d501526133390152600081816104930152818161151201528181611c8b01528181611e3001528181612c59015261327901526000818161069601528181610ab9015281816113730152818161165001528181611df30152818161230a0152818161235c0152612e3801526000611615015260006115e00152600061042301526153c16000f3fe6080604052600436106102bf5760003560e01c806383db382d1161016e578063c620033f116100cb578063d67601281161007f578063da3848db11610064578063da3848db1461082e578063dd62ed3e146108fe578063e035814d1461093657600080fd5b8063d6760128146107f8578063d785598e1461081857600080fd5b8063d3487997116100b0578063d34879971461078d578063d505accf146107ad578063d5ffb4e5146107cd57600080fd5b8063c620033f1461074d578063d0c9bdb41461076357600080fd5b8063a41fe49f11610122578063a932492f11610107578063a932492f1461070d578063ad1383f814610722578063c3bd59451461073757600080fd5b8063a41fe49f146106cd578063a9059cbb146106ed57600080fd5b806395d89b411161015357806395d89b411461066f5780639b147558146106845780639f13f76d146106b857600080fd5b806383db382d1461063057806388a9f8bb1461065957600080fd5b80633644e5151161021c57806362d7d45e116101d05780637ecebe00116101b55780637ecebe00146105c05780637f86d13c146105ed578063819b71c81461061a57600080fd5b806362d7d45e1461055f57806370a082311461059357600080fd5b806355b13a4f1161020157806355b13a4f146104cd5780635d7f850c146105015780635ee04d781461052b57600080fd5b80633644e5151461046c578063443ec74d1461048157600080fd5b806323b872dd1161027357806330adf81f1161025857806330adf81f146103dd578063313ce5671461041157806332e7c5bf1461045757600080fd5b806323b872dd146103825780632505c3d9146103a257600080fd5b80631304fd58116102a45780631304fd581461032657806318160ddd1461034a57806321c281911461036057600080fd5b806306fdde03146102cb578063095ea7b3146102f657600080fd5b366102c657005b600080fd5b3480156102d757600080fd5b506102e061096a565b6040516102ed9190614b58565b60405180910390f35b34801561030257600080fd5b50610316610311366004614ba0565b6109f8565b60405190151581526020016102ed565b34801561033257600080fd5b5061033c60095481565b6040519081526020016102ed565b34801561035657600080fd5b5061033c60025481565b34801561036c57600080fd5b5061038061037b366004614bcc565b610a65565b005b34801561038e57600080fd5b5061031661039d366004614be9565b61117d565b3480156103ae57600080fd5b506103c26103bd366004614c2a565b611271565b604080519384526020840192909252908201526060016102ed565b3480156103e957600080fd5b5061033c7f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c981565b34801561041d57600080fd5b506104457f000000000000000000000000000000000000000000000000000000000000000081565b60405160ff90911681526020016102ed565b34801561046357600080fd5b50610445600281565b34801561047857600080fd5b5061033c6115dc565b34801561048d57600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020016102ed565b3480156104d957600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b34801561050d57600080fd5b50610516611637565b604080519283526020830191909152016102ed565b34801561053757600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b34801561056b57600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b34801561059f57600080fd5b5061033c6105ae366004614bcc565b60036020526000908152604090205481565b3480156105cc57600080fd5b5061033c6105db366004614bcc565b60056020526000908152604090205481565b3480156105f957600080fd5b5061033c610608366004614bcc565b600b6020526000908152604090205481565b34801561062657600080fd5b5061033c60085481565b34801561063c57600080fd5b5061064661019281565b60405160029190910b81526020016102ed565b34801561066557600080fd5b5061033c6101f481565b34801561067b57600080fd5b506102e06116f2565b34801561069057600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b3480156106c457600080fd5b50610445600481565b3480156106d957600080fd5b506105166106e8366004614c5c565b6116ff565b3480156106f957600080fd5b50610316610708366004614ba0565b611d52565b34801561071957600080fd5b50610445601481565b34801561072e57600080fd5b50610445600a81565b34801561074357600080fd5b5061033c600a5481565b34801561075957600080fd5b50610646616c5081565b34801561076f57600080fd5b50610778611dca565b60405163ffffffff90911681526020016102ed565b34801561079957600080fd5b506103806107a8366004614c88565b611de8565b3480156107b957600080fd5b506103806107c8366004614d17565b611e97565b3480156107d957600080fd5b506107e46201518081565b60405162ffffff90911681526020016102ed565b34801561080457600080fd5b50610380610813366004614bcc565b6120f7565b34801561082457600080fd5b5061033c60075481565b34801561083a57600080fd5b506006546108a590600281810b9163010000008104820b9166010000000000008204810b916901000000000000000000810490910b9065ffffffffffff600160601b8204169063ffffffff600160901b8204169060ff600160b01b8204811691600160b81b90041688565b604080516002998a0b815297890b602089015295880b958701959095529290950b606085015265ffffffffffff16608084015263ffffffff90931660a083015291151560c082015290151560e0820152610100016102ed565b34801561090a57600080fd5b5061033c610919366004614d88565b600460209081526000928352604080842090915290825290205481565b34801561094257600080fd5b506104b57f000000000000000000000000000000000000000000000000000000000000000081565b6000805461097790614dc1565b80601f01602080910402602001604051908101604052809291908181526020018280546109a390614dc1565b80156109f05780601f106109c5576101008083540402835291602001916109f0565b820191906000526020600020905b8154815290600101906020018083116109d357829003601f168201915b505050505081565b3360008181526004602090815260408083206001600160a01b038716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92590610a539086815260200190565b60405180910390a35060015b92915050565b60005a90506000806000806000610a7a61221c565b6006805460ff60b81b1916600160b81b1790556040805160608101825260008082526020820181905291810191909152949950929750909550935091507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa158015610b15573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b399190614e1e565b5050505060029190910b6040840152506001600160a01b0316808252610b649080600160601b6123c2565b6001600160e01b031660208201526000610b7d8561246f565b9050610bb17f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316612493565b610be37f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316612493565b6000806000610bf98a8a876000015160006124d4565b92509250925080606001516001600160801b0316600014610c29576060810151610c24908a90612845565b505050505b6000610c5d61271085610c4e86600160601b8b602001516001600160e01b03166123c2565b610c589088614ec8565b6123c2565b9050611324811015610dbd57610c9786604001517f00000000000000000000000000000000000000000000000000000000000000006121f0565b60020b60408b015260608201516001600160801b031615801590610cf357507f00000000000000000000000000000000000000000000000000000000000000008a60400151610ce69190614ee0565b60020b8a6020015160020b145b15610cfd57600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60400151610d2d9190614ee0565b60020b6020808c0191909152860151600090600190610d5b9087906001600160e01b0316600160601b6123c2565b610d659086614f28565b901c90508260200151811115610d7c575060208201515b6000610d866129b1565b905081811015610da057610d9b818303612a4b565b810191505b50610db5610dae8c83612b4d565b8c90612b72565b505050610f3c565b6113ec811115610f0557610df586604001517f00000000000000000000000000000000000000000000000000000000000000006121c1565b60020b60208b015260608201516001600160801b031615801590610e5157507f00000000000000000000000000000000000000000000000000000000000000008a60200151610e449190614f3f565b60020b8a6040015160020b145b15610e5b57600094505b7f00000000000000000000000000000000000000000000000000000000000000008a60200151610e8b9190614f3f565b60020b60408b01526020860151600090600190610eb8908690600160601b906001600160e01b03166123c2565b610ec29087614f28565b8451911c9150811115610ed3575081515b6000610edd612c35565b905081811015610ef757610ef2818303612c88565b810191505b50610db5610dae8c83612d8a565b60408051606081018252600080825260208201819052918101919091529950610f36868c846040015187878c612daf565b9a504298505b5a610f498d615208614f86565b63ffffffff16610f599190614f28565b9b508763ffffffff168c63ffffffff161115610f73578b97505b610f808d868e8b8b6131db565b6002546040805184815260208101929092528101869052606081018590529097507f802a0d65ee1ffb3e6af96deafe1fc3e6402b2672a2f4b79d1b23c4a06c998f349060800160405180910390a16040518061010001604052808c6020015160020b81526020018c6040015160020b81526020018b6020015160020b81526020018b6040015160020b81526020018a65ffffffffffff1681526020018963ffffffff168152602001881515815260200160001515815250600660008201518160000160006101000a81548162ffffff021916908360020b62ffffff16021790555060208201518160000160036101000a81548162ffffff021916908360020b62ffffff16021790555060408201518160000160066101000a81548162ffffff021916908360020b62ffffff16021790555060608201518160000160096101000a81548162ffffff021916908360020b62ffffff160217905550608082015181600001600c6101000a81548165ffffffffffff021916908365ffffffffffff16021790555060a08201518160000160126101000a81548163ffffffff021916908363ffffffff16021790555060c08201518160000160166101000a81548160ff02191690831515021790555060e08201518160000160176101000a81548160ff02191690831515021790555090505050505050505050505050505050565b6001600160a01b038316600090815260046020908152604080832033845290915281205460001981146111d9576111b48382614f28565b6001600160a01b03861660009081526004602090815260408083203384529091529020555b6001600160a01b03851660009081526003602052604081208054859290611201908490614f28565b90915550506001600160a01b03808516600081815260036020526040908190208054870190555190918716907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9061125c9087815260200190565b60405180910390a360019150505b9392505050565b600080808615158061128257508515155b6112d35760405162461bcd60e51b815260206004820152600f60248201527f416c6f653a2030206465706f736974000000000000000000000000000000000060448201526064015b60405180910390fd5b6000806112de61221c565b50506006805460ff60b81b1916600160b81b179055509092509050611302826135ff565b61130b816135ff565b61133d7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316612493565b61136f7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316612493565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa1580156113cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113f39190614e1e565b505050505050905060008061140b85858560016124d4565b509150915061142060025483838f8f886136c2565b91995097509550876114655760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b60448201526064016112ca565b898710156114b55760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f77000000000000000000000060448201526064016112ca565b888610156115055760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f77000000000000000000000060448201526064016112ca565b61153a6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001633308a613808565b61156f6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016333089613808565b611579338961388b565b604080518981526020810189905290810187905233907f36af321ec8d3c75236829c5317affd40ddb308863a1236d2d277a4025cccee1e9060600160405180910390a250506006805460ff60b81b19169055509398929750909550909350505050565b60007f000000000000000000000000000000000000000000000000000000000000000046146116125761160d6138f7565b905090565b507f000000000000000000000000000000000000000000000000000000000000000090565b60008060008061164561221c565b5050509150915060007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316633850c7bd6040518163ffffffff1660e01b815260040160e060405180830381865afa1580156116ac573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906116d09190614e1e565b50505050505090506116e583838360006124d4565b5090969095509350505050565b6001805461097790614dc1565b600080846117405760405162461bcd60e51b815260206004820152600e60248201526d416c6f653a20302073686172657360901b60448201526064016112ca565b60008061174b61221c565b50506006805460ff60b81b1916600160b81b1790555090925090506117986001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016612493565b6117ca7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316612493565b60025460008080806117da612c35565b6007546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa158015611847573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061186b9190614fae565b925083831161187b576000611891565b600a6118878585614f28565b6118919190614fdd565b93506118b2846118a18585614ec8565b6118ab9190614f28565b8d876123c2565b98508189111561192c57816118c78a86614ec8565b6118d19190614f28565b91506119066001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683613991565b83600960008282546119189190614ec8565b9091555061192890508284614f28565b6007555b6119346129b1565b6008546040516370a0823160e01b81523060048201529095509092506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401602060405180830381865afa1580156119a1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119c59190614fae565b92508383116119d55760006119eb565b600a6119e18585614f28565b6119eb9190614fdd565b93506119fb846118a18585614ec8565b975081881115611a755781611a108986614ec8565b611a1a9190614f28565b9150611a4f6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001683613991565b83600a6000828254611a619190614ec8565b90915550611a7190508284614f28565b6008555b6000611a8088613a0b565b505050509050611aa4611a9d826001600160801b03168f896123c2565b8990612845565b92975090955093509150611ab8858b614ec8565b9950611ac4848a614ec8565b9850611ad1600a84614fdd565b9450611ade600a83614fdd565b9350611af4611aed8685614f28565b8e886123c2565b611afe908b614ec8565b9950611b0d611aed8584614f28565b611b17908a614ec8565b98508460096000828254611b2b9190614ec8565b9250508190555083600a6000828254611b449190614ec8565b9250508190555050856040015160020b866020015160020b14611bde576000611b6c87613a0b565b505050509050611b90611b89826001600160801b03168f896123c2565b8890612845565b92975090955093509150611ba5838e886123c2565b611baf9086614ec8565b611bb9908b614ec8565b9950611bc6828e886123c2565b611bd09085614ec8565b611bda908a614ec8565b9850505b8a891015611c2e5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743020746f6f206c6f77000000000000000000000060448201526064016112ca565b89881015611c7e5760405162461bcd60e51b815260206004820152601560248201527f416c6f653a20616d6f756e743120746f6f206c6f77000000000000000000000060448201526064016112ca565b611cb26001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338b613af3565b611ce66001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016338a613af3565b611cf0338d613b23565b604080518d8152602081018b905290810189905233907f02f25270a4d87bea75db541cdfe559334a275b4a233520ed6c0a2429667cca949060600160405180910390a250506006805460ff60b81b191690555094989397509295505050505050565b33600090815260036020526040812080548391908390611d73908490614f28565b90915550506001600160a01b038316600081815260036020526040908190208054850190555133907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90610a539086815260200190565b60065460009061160d90600160601b900465ffffffffffff1661246f565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001614611e1d57600080fd5b8315611e5757611e576001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163386613af3565b8215611e9157611e916001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163385613af3565b50505050565b42841015611ee75760405162461bcd60e51b815260206004820152601760248201527f5045524d49545f444541444c494e455f4558504952454400000000000000000060448201526064016112ca565b6000611ef16115dc565b6001600160a01b0389811660008181526005602090815260409182902080546001810190915582517f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c98184015280840194909452938c166060840152608083018b905260a083019390935260c08083018a90528151808403909101815260e08301909152805192019190912061190160f01b6101008301526101028201929092526101228101919091526101420160408051601f198184030181528282528051602091820120600080855291840180845281905260ff88169284019290925260608301869052608083018590529092509060019060a0016020604051602081039080840390855afa15801561200a573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116158015906120405750886001600160a01b0316816001600160a01b0316145b61208c5760405162461bcd60e51b815260206004820152600e60248201527f494e56414c49445f5349474e455200000000000000000000000000000000000060448201526064016112ca565b6001600160a01b0390811660009081526004602090815260408083208b8516808552908352928190208a905551898152919350918a16917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a350505050505050565b600061210161221c565b50506006805460ff60b81b1916600160b81b17905592506000915061212790508261246f565b9050620aae6063ffffffff8216116121815760405162461bcd60e51b815260206004820152601360248201527f416c6f653a207365656d73206e6f6d696e616c0000000000000000000000000060448201526064016112ca565b6001600160a01b0383166000908152600b60209081526040808320839055600c90915281206121af91614b01565b50506006805460ff60b81b1916905550565b6000806121ce8385614ff1565b905060008160020b13156121e757830382019050610a5f565b90920392915050565b6000806121fd8385614ff1565b905060008160020b126122135783039050610a5f565b90920303919050565b604080516060810182526000808252602082018190529181019190915260408051606081018252600080825260208201819052918101919091526040805161010081018252600654600281810b835263010000008204810b602084015266010000000000008204810b938301939093526901000000000000000000810490920b606082015265ffffffffffff600160601b830416608082015263ffffffff600160901b83041660a082015260ff600160b01b83048116151560c0830152600160b81b90920490911615801560e083015260009182918291906122fd57600080fd5b60405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001826000015160020b8152602001826020015160020b81525060405180606001604052807f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602001836040015160020b8152602001836060015160020b81525082608001518360a001518460c0015195509550955095509550509091929394565b6000816123ce57600080fd5b60008060001985870985870292508281108382030391505080600014156123fa5750829004905061126a565b83811061240657600080fd5b60008486880960026001871981018816978890046003810283188082028403028082028403028082028403028082028403028082028403029081029092039091026000889003889004909101858311909403939093029303949094049190911702949350505050565b6000610a5f620186a061248a65ffffffffffff851642614f28565b620151806123c2565b6040805160048152602481019091526020810180516001600160e01b0316630302f06b60e31b1790526124d0906001600160a01b03831690613b97565b5050565b60408051608081018252600080825260208201819052918101829052606081018290528190600080876040015160020b886020015160020b146125775761251a88613a0b565b6001600160801b039485166060890181905291851696509093169350612545928b92508a9150613bbc565b60208501528084528290849061255c908390614ec8565b905250602083018051829190612573908390614ec8565b9052505b6007546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156125e1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906126059190614fae565b905081811161261557600061262b565b600a6126218383614f28565b61262b9190614fdd565b915085612638578161263b565b60005b81612644612c35565b61264e9190614ec8565b6126589190614f28565b83518490612667908390614ec8565b9052506008546040516370a0823160e01b81523060048201529092507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156126d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906126f89190614fae565b905081811161270857600061271e565b600a6127148383614f28565b61271e9190614fdd565b91508561272b578161272e565b60005b816127376129b1565b6127419190614ec8565b61274b9190614f28565b8360200181815161275c9190614ec8565b905250604089015160208a0151600291820b910b1461282c5761277e89613a0b565b6001600160801b0394851660408901819052918516965090931693506127a9928c92508a9150613bbc565b9095509350856127c3576127be600a83614fdd565b6127c6565b60005b83516127d3908490614ec8565b6127dd9190614f28565b6127e79086614ec8565b9450856127fe576127f9600a82614fdd565b612801565b60005b8184602001516128119190614ec8565b61281b9190614f28565b6128259085614ec8565b9350612839565b8251602084015190955093505b50509450945094915050565b60008080806001600160801b038516156128ef5785516020870151604080890151905163a34123a760e01b8152600292830b6004820152910b60248201526001600160801b03871660448201526001600160a01b039091169063a34123a79060640160408051808303816000875af11580156128c5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906128e99190615013565b90945092505b8551602087015160408089015190516309e3d67b60e31b8152306004820152600292830b6024820152910b60448201526001600160801b0360648201819052608482015260009182916001600160a01b0390911690634f1eb3d89060a40160408051808303816000875af115801561296b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061298f919061504e565b96999598506001600160801b039081168a900397509095168790039450505050565b600a546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a08231906024015b602060405180830381865afa158015612a1d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612a419190614fae565b61160d9190614f28565b6008546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015612ab8573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612adc9190614fae565b9050818111612aec576000612af3565b600a828203045b9150818103841115612b055781810393505b612b3a6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016838601613991565b600a805483019055038290036008555090565b600061126a612b5f8460200151613bef565b612b6c8560400151613bef565b84613f42565b6000806001600160801b03831615612c2e57835160208501516040808701519051633c8a7d8d60e01b8152306004820152600292830b6024820152910b60448201526001600160801b038516606482015260a06084820152600060a48201526001600160a01b0390911690633c8a7d8d9060c40160408051808303816000875af1158015612c04573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612c289190615013565b90925090505b9250929050565b6009546040516370a0823160e01b8152306004820152600091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016906370a0823190602401612a00565b6007546040516370a0823160e01b81523060048201526000919082907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa158015612cf5573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612d199190614fae565b9050818111612d29576000612d30565b600a828203045b9150818103841115612d425781810393505b612d776001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016838601613991565b6009805483019055038290036007555090565b600061126a612d9c8460200151613bef565b612da98560400151613bef565b84613f93565b604080516060810182526000808252602082018190529181018290529080612dd78888612845565b935093505050600a60ff168281612df057612df0614fc7565b60098054929091049091019055600a805491819004909101905550600082612e1a57616c50612ee9565b87516040808a015190516326fbd52f60e01b81526001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081166004830152928316602482015260029190910b6044820152612ee9917f000000000000000000000000000000000000000000000000000000000000000016906326fbd52f906064016020604051808303816000875af1158015612ec0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612ee49190614fae565b613fea565b60020b60011d9050600080612eff878785614064565b91509150600080612f15896101f46127106123c2565b612f1d612c35565b039150612f2f886101f46127106123c2565b612f376129b1565b03905083821215612f565760009850612f51828503612c88565b820193505b82811215612f725760009750612f6d818403612a4b565b810192505b612fa2858d60400151037f00000000000000000000000000000000000000000000000000000000000000006121f0565b60020b60208c015260408c0151612fdb9086017f00000000000000000000000000000000000000000000000000000000000000006121c1565b600290810b60408d015260208c01517f0000000000000000000000000000000000000000000000000000000000000000820b910b121561303f577f000000000000000000000000000000000000000000000000000000000000000060020b60208c01525b7f000000000000000000000000000000000000000000000000000000000000000060020b8b6040015160020b131561309b577f000000000000000000000000000000000000000000000000000000000000000060020b60408c01525b8b516130ae90610dae908d9087876140d9565b90945092508815613117576130f66130c68584614f28565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690614100565b6131008483614f28565b600760008282546131119190614ec8565b90915550505b871561317b5761315a61312a8483614f28565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690614100565b6131648382614f28565b600860008282546131759190614ec8565b90915550505b7fe73e1a034909b10f2cbe101ce0618d683b1485c1c2da61474bdbebce08bcaf1a8b602001518c604001516040516131c3929190600292830b8152910b602082015260400190565b60405180910390a150989a9950505050505050505050565b60006001600160a01b03861661323757604080516000808252602082015263ffffffff87168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a150806135f6565b6001600160a01b0386166000908152600b60205260408120549061327561326463ffffffff881684615081565b8863ffffffff16633b9aca006123c2565b90507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b0316141561333757600954808211806132c0575082155b156132c9578091505b6132d38282614f28565b905060006132f46132e5601486615081565b8863ffffffff166127106123c2565b90508082116133035781613305565b805b600955808211156133195760019550613330565b613324600482614fdd565b82101561333057600095505b5050613572565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316886001600160a01b031614156133ca57600a5480821180613380575082155b15613389578091505b6133938282614f28565b905060006133a56132e5601486615081565b90508082116133b457816133b6565b805b600a55808211156133195760019550613330565b6040516370a0823160e01b81523060048201526000906001600160a01b038a16906370a0823190602401602060405180830381865afa158015613411573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906134359190614fae565b905080821180613443575082155b1561344c578091505b60405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa1580156134b2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906134d691906150a0565b8015613567575060405163026c7dfb60e31b81526001600160a01b038a811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631363efd890602401602060405180830381865afa158015613543573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061356791906150a0565b61357057600080fd5b505b6135866001600160a01b0389163383613af3565b6135a28861359d612710848a63ffffffff166123c2565b61411f565b604080516001600160a01b038a1681526020810183905263ffffffff89168183015290517faf945aff5cea2d4d4f891882674c81bcdaeb15609c6d7bc80875dbc4ee83e4ee9181900360600190a183925050505b95945050505050565b806040015160020b816020015160020b14156136185750565b600061362382613a0b565b505050509050806001600160801b03166000146124d05781516020830151604080850151905163a34123a760e01b8152600292830b6004820152910b6024820152600060448201526001600160a01b039091169063a34123a79060640160408051808303816000875af115801561369e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611e919190615013565b600080808815806136d257508715155b806136dc57508615155b6136e8576136e86150bb565b8861375d5760006137076001600160a01b03861680600160601b6123c2565b905061372186600160601b836001600160e01b03166123c2565b92508683101561373657859150819350613757565b86925061375183826001600160e01b0316600160601b6123c2565b91508293505b506137fc565b8761377657508361376f818a896123c2565b92506137fc565b866137895785915061376f828a8a6123c2565b60008789106137a45761379d87898b6123c2565b86106137b2565b866137b0878b8b6123c2565b105b905080156137dc578591506137c8828a8a6123c2565b92506137d5828b8a6123c2565b93506137fa565b8692506137ea83898b6123c2565b91506137f7838b8b6123c2565b93505b505b96509650969350505050565b6040516001600160a01b0380851660248301528316604482015260648101829052611e919085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091526141d6565b806002600082825461389d9190614ec8565b90915550506001600160a01b0382166000818152600360209081526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91015b60405180910390a35050565b60007f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f600060405161392991906150d1565b6040805191829003822060208301939093528101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc660608201524660808201523060a082015260c00160405160208183030381529060405280519060200120905090565b60405160248101829052613a0690632e1a7d4d60e01b906044015b60408051601f198184030181529190526020810180516001600160e01b03167fffffffff00000000000000000000000000000000000000000000000000000000909316929092179091526001600160a01b03841690613b97565b505050565b600080600080600085600001516001600160a01b031663514ea4bf3088602001518960400151604051602001613a6c9392919060609390931b6bffffffffffffffffffffffff1916835260e891821b6014840152901b6017820152601a0190565b604051602081830303815290604052805190602001206040518263ffffffff1660e01b8152600401613aa091815260200190565b60a060405180830381865afa158015613abd573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613ae1919061516d565b939a9299509097509550909350915050565b6040516001600160a01b038316602482015260448101829052613a0690849063a9059cbb60e01b9060640161383c565b6001600160a01b03821660009081526003602052604081208054839290613b4b908490614f28565b90915550506002805482900390556040518181526000906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020016138eb565b606061126a8383604051806060016040528060278152602001615365602791396142bb565b600080613be384613bd08760200151613bef565b613bdd8860400151613bef565b866143a6565b91509150935093915050565b60008060008360020b12613c06578260020b613c13565b8260020b613c13906151c4565b9050613c22620d89e7196151e1565b62ffffff16811115613c5a5760405162461bcd60e51b81526020600482015260016024820152601560fa1b60448201526064016112ca565b600060018216613c7b57700100000000000000000000000000000000613c8d565b6ffffcb933bd6fad37aa2d162d1a5940015b70ffffffffffffffffffffffffffffffffff1690506002821615613cc1576ffff97272373d413259a46990580e213a0260801c5b6004821615613ce0576ffff2e50f5f656932ef12357cf3c7fdcc0260801c5b6008821615613cff576fffe5caca7e10e4e61c3624eaa0941cd00260801c5b6010821615613d1e576fffcb9843d60f6159c9db58835c9266440260801c5b6020821615613d3d576fff973b41fa98c081472e6896dfb254c00260801c5b6040821615613d5c576fff2ea16466c96a3843ec78b326b528610260801c5b6080821615613d7b576ffe5dee046a99a2a811c461f1969c30530260801c5b610100821615613d9b576ffcbe86c7900a88aedcffc83b479aa3a40260801c5b610200821615613dbb576ff987a7253ac413176f2b074cf7815e540260801c5b610400821615613ddb576ff3392b0822b70005940c7a398e4b70f30260801c5b610800821615613dfb576fe7159475a2c29b7443b29c7fa6e889d90260801c5b611000821615613e1b576fd097f3bdfd2022b8845ad8f792aa58250260801c5b612000821615613e3b576fa9f746462d870fdf8a65dc1f90e061e50260801c5b614000821615613e5b576f70d869a156d2a1b890bb3df62baf32f70260801c5b618000821615613e7b576f31be135f97d08fd981231505542fcfa60260801c5b62010000821615613e9c576f09aa508b5b7a84e1c677de54f3e99bc90260801c5b62020000821615613ebc576e5d6af8dedb81196699c329225ee6040260801c5b62040000821615613edb576d2216e584f5fa1ea926041bedfe980260801c5b62080000821615613ef8576b048a170391f7dc42444e8fa20260801c5b60008460020b1315613f19578060001981613f1557613f15614fc7565b0490505b640100000000810615613f2d576001613f30565b60005b60ff16602082901c0192505050919050565b6000826001600160a01b0316846001600160a01b03161115613f62579192915b613f8b613f8683600160601b613f788888615204565b6001600160a01b03166123c2565b614488565b949350505050565b6000826001600160a01b0316846001600160a01b03161115613fb3579192915b6000613fd6856001600160a01b0316856001600160a01b0316600160601b6123c2565b90506135f6613f868483613f788989615204565b6000662358b99a116be082116140035750610192919050565b67053448a481510200821061401b5750616c50919050565b614026600283615081565b91506000670de0b6b3a7640000839003730de0b6b3a76400000000000000000000000000008161405857614058614fc7565b04905061126a816144a3565b60008080614079614074856151e1565b613bef565b614090906001600160a01b0316600160601b614f28565b90506140af86826bffffffffffffffffffffffff16600160601b6123c2565b92506140ce85826bffffffffffffffffffffffff16600160601b6123c2565b915050935093915050565b60006135f6846140ec8760200151613bef565b6140f98860400151613bef565b86866147ea565b60405160248101829052613a069063b6b55f2560e01b906044016139ac565b6001600160a01b0382166000908152600c60209081526040808320600d9092529091205460ff16600e83049250818160ff16600e81106141615761416161522c565b01546001600160a01b0385166000908152600b6020526040902080548501919091039055828260ff8316600e811061419b5761419b61522c565b0155600e60ff60018301166001600160a01b03959095166000908152600d60205260409020805460ff19169190950660ff1617909355505050565b600061422b826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166148a29092919063ffffffff16565b805190915015613a06578080602001905181019061424991906150a0565b613a065760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f7420737563636565640000000000000000000000000000000000000000000060648201526084016112ca565b6060833b6143315760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f60448201527f6e7472616374000000000000000000000000000000000000000000000000000060648201526084016112ca565b600080856001600160a01b03168560405161434c9190615242565b600060405180830381855af49150503d8060008114614387576040519150601f19603f3d011682016040523d82523d6000602084013e61438c565b606091505b509150915061439c8282866148b1565b9695505050505050565b600080836001600160a01b0316856001600160a01b031611156143c7579293925b846001600160a01b0316866001600160a01b0316116143fb576143eb8585856148ea565b6001600160e01b0316915061447f565b836001600160a01b0316866001600160a01b03161015614457576144208685856148ea565b6001600160e01b03169150614436858785614978565b77ffffffffffffffffffffffffffffffffffffffffffffffff16905061447f565b614462858585614978565b77ffffffffffffffffffffffffffffffffffffffffffffffff1690505b94509492505050565b806001600160801b038116811461449e57600080fd5b919050565b60006401000276a36001600160a01b038316108015906144df575073fffd8963efd1fc6a506488495d951d5263988d266001600160a01b038316105b61450f5760405162461bcd60e51b81526020600482015260016024820152602960f91b60448201526064016112ca565b77ffffffffffffffffffffffffffffffffffffffff00000000602083901b166001600160801b03811160071b81811c67ffffffffffffffff811160061b90811c63ffffffff811160051b90811c61ffff811160041b90811c60ff8111600390811b91821c600f811160021b90811c918211600190811b92831c979088119617909417909217179091171717608081106145b7576145ad607f82614f28565b83901c91506145c8565b6145c281607f614f28565b83901b91505b600060406145d760808461525e565b901b9050828302607f1c92508260801c80603f1b8217915083811c935050828302607f1c92508260801c80603e1b8217915083811c935050828302607f1c92508260801c80603d1b8217915083811c935050828302607f1c92508260801c80603c1b8217915083811c935050828302607f1c92508260801c80603b1b8217915083811c935050828302607f1c92508260801c80603a1b8217915083811c935050828302607f1c92508260801c8060391b8217915083811c935050828302607f1c92508260801c8060381b8217915083811c935050828302607f1c92508260801c8060371b8217915083811c935050828302607f1c92508260801c8060361b8217915083811c935050828302607f1c92508260801c8060351b8217915083811c935050828302607f1c92508260801c8060341b8217915083811c935050828302607f1c92508260801c8060331b8217915083811c935050828302607f1c92508260801c8060321b8217915050600081693627a301d71055774c8561475a919061529d565b90506000608061477a6f028f6481ab7f045a5af012a19d003aaa8461525e565b901d90506000608061479c846fdb2df09e81959a81455e260799a0632f615324565b901d90508060020b8260020b146147db57886001600160a01b03166147c082613bef565b6001600160a01b031611156147d557816147dd565b806147dd565b815b9998505050505050505050565b6000836001600160a01b0316856001600160a01b0316111561480a579293925b846001600160a01b0316866001600160a01b0316116148355761482e858585613f93565b90506135f6565b836001600160a01b0316866001600160a01b0316101561489757600061485c878686613f93565b9050600061486b878986613f42565b9050806001600160801b0316826001600160801b03161061488c578061488e565b815b925050506135f6565b61439c858584613f42565b6060613f8b84846000856149c2565b606083156148c057508161126a565b8251156148d05782518084602001fd5b8160405162461bcd60e51b81526004016112ca9190614b58565b6000826001600160a01b0316846001600160a01b0316111561490a579192915b6001600160a01b03841661495c7bffffffffffffffffffffffffffffffff000000000000000000000000606085901b166149448787615204565b6001600160a01b0316866001600160a01b03166123c2565b6149669190614fdd565b67ffffffffffffffff16949350505050565b6000826001600160a01b0316846001600160a01b03161115614998579192915b613f8b6001600160801b0383166149af8686615204565b6001600160a01b0316600160601b6123c2565b606082471015614a3a5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c000000000000000000000000000000000000000000000000000060648201526084016112ca565b843b614a885760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e747261637400000060448201526064016112ca565b600080866001600160a01b03168587604051614aa49190615242565b60006040518083038185875af1925050503d8060008114614ae1576040519150601f19603f3d011682016040523d82523d6000602084013e614ae6565b606091505b5091509150614af68282866148b1565b979650505050505050565b50614b1090600e810190614b13565b50565b5b80821115614b285760008155600101614b14565b5090565b60005b83811015614b47578181015183820152602001614b2f565b83811115611e915750506000910152565b6020815260008251806020840152614b77816040850160208701614b2c565b601f01601f19169190910160400192915050565b6001600160a01b0381168114614b1057600080fd5b60008060408385031215614bb357600080fd5b8235614bbe81614b8b565b946020939093013593505050565b600060208284031215614bde57600080fd5b813561126a81614b8b565b600080600060608486031215614bfe57600080fd5b8335614c0981614b8b565b92506020840135614c1981614b8b565b929592945050506040919091013590565b60008060008060808587031215614c4057600080fd5b5050823594602084013594506040840135936060013592509050565b600080600060608486031215614c7157600080fd5b505081359360208301359350604090920135919050565b60008060008060608587031215614c9e57600080fd5b8435935060208501359250604085013567ffffffffffffffff80821115614cc457600080fd5b818701915087601f830112614cd857600080fd5b813581811115614ce757600080fd5b886020828501011115614cf957600080fd5b95989497505060200194505050565b60ff81168114614b1057600080fd5b600080600080600080600060e0888a031215614d3257600080fd5b8735614d3d81614b8b565b96506020880135614d4d81614b8b565b955060408801359450606088013593506080880135614d6b81614d08565b9699959850939692959460a0840135945060c09093013592915050565b60008060408385031215614d9b57600080fd5b8235614da681614b8b565b91506020830135614db681614b8b565b809150509250929050565b600181811c90821680614dd557607f821691505b60208210811415614df657634e487b7160e01b600052602260045260246000fd5b50919050565b805161ffff8116811461449e57600080fd5b8051801515811461449e57600080fd5b600080600080600080600060e0888a031215614e3957600080fd5b8751614e4481614b8b565b8097505060208801518060020b8114614e5c57600080fd5b9550614e6a60408901614dfc565b9450614e7860608901614dfc565b9350614e8660808901614dfc565b925060a0880151614e9681614d08565b9150614ea460c08901614e0e565b905092959891949750929550565b634e487b7160e01b600052601160045260246000fd5b60008219821115614edb57614edb614eb2565b500190565b60008160020b8360020b6000811281627fffff1901831281151615614f0757614f07614eb2565b81627fffff018313811615614f1e57614f1e614eb2565b5090039392505050565b600082821015614f3a57614f3a614eb2565b500390565b60008160020b8360020b6000821282627fffff03821381151615614f6557614f65614eb2565b82627fffff19038212811615614f7d57614f7d614eb2565b50019392505050565b600063ffffffff808316818516808303821115614fa557614fa5614eb2565b01949350505050565b600060208284031215614fc057600080fd5b5051919050565b634e487b7160e01b600052601260045260246000fd5b600082614fec57614fec614fc7565b500490565b60008260020b8061500457615004614fc7565b808360020b0791505092915050565b6000806040838503121561502657600080fd5b505080516020909101519092909150565b80516001600160801b038116811461449e57600080fd5b6000806040838503121561506157600080fd5b61506a83615037565b915061507860208401615037565b90509250929050565b600081600019048311821515161561509b5761509b614eb2565b500290565b6000602082840312156150b257600080fd5b61126a82614e0e565b634e487b7160e01b600052600160045260246000fd5b600080835481600182811c9150808316806150ed57607f831692505b602080841082141561510d57634e487b7160e01b86526022600452602486fd5b81801561512157600181146151325761515f565b60ff1986168952848901965061515f565b60008a81526020902060005b868110156151575781548b82015290850190830161513e565b505084890196505b509498975050505050505050565b600080600080600060a0868803121561518557600080fd5b61518e86615037565b945060208601519350604086015192506151aa60608701615037565b91506151b860808701615037565b90509295509295909350565b6000600160ff1b8214156151da576151da614eb2565b5060000390565b60008160020b627fffff198114156151fb576151fb614eb2565b60000392915050565b60006001600160a01b038381169083168181101561522457615224614eb2565b039392505050565b634e487b7160e01b600052603260045260246000fd5b60008251615254818460208701614b2c565b9190910192915050565b60008083128015600160ff1b85018412161561527c5761527c614eb2565b836001600160ff1b0301831381161561529757615297614eb2565b50500390565b60006001600160ff1b036000841360008413858304851182821616156152c5576152c5614eb2565b600160ff1b60008712828116878305891216156152e4576152e4614eb2565b6000871292508782058712848416161561530057615300614eb2565b8785058712818416161561531657615316614eb2565b505050929093029392505050565b6000808212826001600160ff1b030384138115161561534557615345614eb2565b600160ff1b839003841281161561535e5761535e614eb2565b5050019056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122061878ece88dc64300cd7cdbcefc6857ab430999697f4f1f7a20e75a6fba6ecf864736f6c634300080a0033";
const UINT256MAX = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

const ADDRESS_UNI_POOL = "0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640";
const ADDRESS_CTOKEN0 = "0x39AA39c021dfbaE8faC545936693aC917d5E7563";
const ADDRESS_CTOKEN1 = "0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5";
const WHALE = "0x4F868C1aa37fCf307ab38D215382e88FCA6275E2";

function prettyPrintRebalance(tx) {
  console.log(" The vault was rebalanced!");
  for (const log of tx.logs) {
    console.log(`\t${log.event}`);

    if (log.event === "Recenter") {
      const lower = log.args.lower.toNumber();
      const upper = log.args.upper.toNumber();
      const middle = Math.round((lower + upper) / 2);

      console.log(`\t   || ${lower} |======> ${middle} <======| ${upper} ||`);
    } else if (log.event === "Reward") {
      const token = log.args.token;
      const amount = log.args.amount.toNumber();
      const urgency = log.args.urgency.toNumber();

      console.log(`\t   urgency=${urgency / 1e5} ---> ${amount / 1e9} of ${token.slice(0, 6)}`);
    } else if (log.event === "Rebalance") {
      const ratio = log.args.ratio.toString(0);
      const shares = log.args.shares.toString(0);
      const inventory0 = log.args.inventory0.toString(0);
      const inventory1 = log.args.inventory1.toString(0);

      console.log(`\t   ratio=${ratio}  (${inventory0} / ${inventory1})`);
      console.log(`\t   ${shares} outstanding shares`);
    } else if (log.event === "Transfer") {
      let from = log.args.from;
      let to = log.args.to;
      const amount = log.args.amount.toString(0);

      if (from === ADDRESS_UNI_POOL) from = "Uniswap";
      else if (from === ADDRESS_CTOKEN0) from = "silo0";
      else if (from === ADDRESS_CTOKEN1) from = "silo1";
      if (to === ADDRESS_UNI_POOL) to = "Uniswap";
      else if (to === ADDRESS_CTOKEN0) to = "silo0";
      else if (to === ADDRESS_CTOKEN1) to = "silo1";

      console.log(`\t   (${log.address.slice(0, 7)})`);
      console.log(`\t   ${amount} from ${from.slice(0, 7)} to ${to.slice(0, 7)}`);
    }
  }
}

describe("USDC-WETH 0.05% | cUSDC | cETH @hardhat", () => {

  let accounts;
  let multisig;

  let aloeBlend;
  let factory;
  let oracle;
  let silo0;
  let silo1;

  let token0;
  let token1;

  before(async () => {
    await web3.eth.hardhat.reset({
      forking: {
        jsonRpcUrl: `https://eth-mainnet.alchemyapi.io/v2/${process.env.PROVIDER_ALCHEMY_KEY}`,
        blockNumber: 12802299,
      },
      accounts: [
        {
          privateKey: "0101010101010101010101010101010101010101010101010101010101010101",
          balance: "2000000000000000000",
        },
        {
          privateKey: process.env.DEPLOYER,
          balance: "2000000000000000000",
        },
      ],
    });
  });

  it("should deploy", async () => {
    accounts = await web3.eth.getAccounts();
    multisig = accounts[0];

    const deployer = web3.eth.accounts.privateKeyToAccount(process.env.DEPLOYER);

    oracle = await VolatilityOracle.new();
    factory = await Factory.new(oracle.address, BYTECODE);
    silo0 = await CompoundCTokenSilo.new(ADDRESS_CTOKEN0, {
      from: deployer.address,
    });
    silo1 = await CompoundCEtherSilo.new(ADDRESS_CTOKEN1, {
      from: deployer.address,
    });

    await factory.createVault(ADDRESS_UNI_POOL, silo0.address, silo1.address, {
      from: deployer.address,
    });
    const vaultAddress = await factory.getVault(ADDRESS_UNI_POOL, silo0.address, silo1.address);
    aloeBlend = await AloeBlend.at(vaultAddress);
    token0 = await ERC20.at(await aloeBlend.TOKEN0());
    token1 = await ERC20.at(await aloeBlend.TOKEN1());
  });

  it("should get inventory (zero)", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("0");
    expect(res.inventory1.toString(10)).to.equal("0");
  });

  it("should impersonate whale", async () => {
    await web3.eth.hardhat.impersonate(WHALE);

    const balance0 = await token0.balanceOf(WHALE);
    const balance1 = await token1.balanceOf(WHALE);

    expect(balance0.gt(2000e6)).to.be.true;
    expect(balance1.gt(1e18)).to.be.true;
  });

  it("should fail to deposit before approving tokens", async () => {
    const tx = aloeBlend.deposit("100000000", "100000000000000000", 0, 0, {
      from: WHALE,
    });
    await expect(tx).to.eventually.be.rejectedWith(
      Error,
      "VM Exception while processing transaction: reverted with reason string 'ERC20: transfer amount exceeds allowance'"
    );
  });

  it("should approve tokens for vault management", async () => {
    const tx0 = await token0.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    const tx1 = await token1.approve(aloeBlend.address, UINT256MAX, {
      from: WHALE,
    });
    expect(tx0.receipt.status).to.be.true;
    expect(tx1.receipt.status).to.be.true;
  });

  it("should deposit", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "50000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("100000000");
    expect(deposit.args.amount0.toString(10)).to.equal("100000000");
    expect(deposit.args.amount1.toString(10)).to.equal("47451794160948057");
  });

  it("should deposit proportionally", async () => {
    const tx0 = await aloeBlend.deposit("100000000", "40000000000000000", 0, 0, {
      from: WHALE,
    });
    const deposit = tx0.logs[3];
    expect(deposit.event).to.equal("Deposit");
    expect(deposit.args.sender).to.equal(WHALE);
    expect(deposit.args.shares.toString(10)).to.equal("84296075");
    expect(deposit.args.amount0.toString(10)).to.equal("84296075");
    expect(deposit.args.amount1.toString(10)).to.equal("40000000000000000");
  });

  it("should rebalance", async () => {
    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589708047402); // 5% of inventory1 (contract float)

    const urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should go to next block", async () => {
    await web3.eth.hardhat.mine();
  });

  it("should get inventory before rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794076657509");
  });

  it("should rebalance again", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(1);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4380941078269389); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory after rebalance", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296074");
    expect(res.inventory1.toString(10)).to.equal("87451794079037807");
  });

  it("should rebalance a third time", async () => {
    let urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0);

    const tx0 = await aloeBlend.rebalance("0x0000000000000000000000000000000000000000");
    console.log(`Rebalance gas: ${tx0.receipt.gasUsed}`);

    prettyPrintRebalance(tx0);

    const balance0 = (await token0.balanceOf(aloeBlend.address)).toNumber();
    const balance1 = (await token1.balanceOf(aloeBlend.address)).toNumber();
    expect(balance0).to.equal(9214803); // 5% of inventory0 (contract float)
    expect(balance1).to.equal(4372589705422976); // 5% of inventory1 (contract float)

    urgency = (await aloeBlend.getRebalanceUrgency()).toNumber();
    expect(urgency).to.equal(0); // urgency should go to 0 immediately after rebalance
  });

  it("should get inventory once more", async () => {
    const res = await aloeBlend.getInventory();

    expect(res.inventory0.toString(10)).to.equal("184296073");
    expect(res.inventory1.toString(10)).to.equal("87451794088820670");
  });

  it("should withdraw", async () => {
    const shares = (await aloeBlend.balanceOf(WHALE)).toNumber();
    expect(shares).to.equal(184296075);

    const tx0 = await aloeBlend.withdraw("184296075", 0, 0, { from: WHALE });
    const withdraw = tx0.logs[tx0.logs.length - 1];
    expect(withdraw.event).to.equal("Withdraw");
    expect(withdraw.args.shares.toString(10)).to.equal("184296075");
    expect(withdraw.args.amount0.toString(10)).to.equal("184296074");
    expect(withdraw.args.amount1.toString(10)).to.equal("87451794118248630");

    console.log((await token0.balanceOf(aloeBlend.address)).toString(10));
    console.log((await token1.balanceOf(aloeBlend.address)).toString(10));
  });
});
